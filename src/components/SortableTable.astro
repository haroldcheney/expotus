---
/**
 * A table that supports client-side sorting by clicking column headers.
 * Wrap a <table> element and add data-sortable="key" to <th> elements.
 */
---

<div class="list sortable-table">
  <slot />
</div>

<script>
  document.querySelectorAll('.sortable-table table').forEach((table) => {
    const headers = table.querySelectorAll('th[data-sortable]');
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    let currentSort = '';
    let ascending = true;

    headers.forEach((th) => {
      th.setAttribute('aria-sort', 'none');

      const btn = document.createElement('button');
      btn.textContent = th.textContent?.trim() ?? '';

      const indicator = document.createElement('span');
      indicator.setAttribute('aria-hidden', 'true');
      indicator.className = 'sort-indicator';
      indicator.textContent = ' \u2195';

      btn.appendChild(indicator);
      th.textContent = '';
      th.appendChild(btn);

      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sortable')!;
        if (currentSort === key) {
          ascending = !ascending;
        } else {
          currentSort = key;
          ascending = true;
        }

        // Update header classes, aria-sort, and indicators
        headers.forEach((h) => {
          h.classList.remove('asc', 'desc');
          h.setAttribute('aria-sort', 'none');
          const ind = h.querySelector('.sort-indicator');
          if (ind) ind.textContent = ' \u2195';
        });
        th.classList.add(ascending ? 'asc' : 'desc');
        th.setAttribute('aria-sort', ascending ? 'ascending' : 'descending');
        const ind = th.querySelector('.sort-indicator');
        if (ind) ind.textContent = ascending ? ' \u25B2' : ' \u25BC';

        // Sort rows
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const aCell = a.querySelector(`td[data-sort-key="${key}"]`);
          const bCell = b.querySelector(`td[data-sort-key="${key}"]`);
          if (!aCell || !bCell) return 0;
          const aVal = aCell.getAttribute('data-sort-value') || aCell.textContent || '';
          const bVal = bCell.getAttribute('data-sort-value') || bCell.textContent || '';

          const aNum = parseFloat(aVal);
          const bNum = parseFloat(bVal);
          if (!isNaN(aNum) && !isNaN(bNum)) {
            return ascending ? aNum - bNum : bNum - aNum;
          }

          return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        });

        // Re-render with updated row numbers and zebra striping
        rows.forEach((row, i) => {
          const numCell = row.querySelector('td[data-sort-key="rownum"]');
          if (numCell) numCell.textContent = String(i + 1);
          row.className = i % 2 === 0 ? 'odd' : 'even';
          tbody.appendChild(row);
        });
      });
    });
  });
</script>
